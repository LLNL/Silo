name: Basic

on:
  push:
    branches: ["mcm86-30jul24-gh-actions-ci"]
  pull_request:
    branches: [ "main" ]
    
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install HDF5
      run: |
        wget -q https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.14/hdf5-1.14.4/bin/unix/hdf5-1.14.4-3-ubuntu-2204_gcc.tar.gz
        mkdir hdf5-1.14.4-3
        tar -xf hdf5-1.14.4-3-ubuntu-2204_gcc.tar.gz
        tar -xf hdf5/HDF5-1.14.4.3-Linux.tar.gz --strip-components=4 -C hdf5-1.14.4-3
        rm -rf hdf5

    - name: Build Silo
      run: |
        export PATH="$PWD/hdf5-1.14.4-3/bin:$PATH"
        mkdir build
        cd build
        env LDFLAGS=-Wl,-rpath,`pwd`/../hdf5-1.14.4-3/lib FFLAGS=-fallow-argument-mismatch FCFLAGS=-fallow-argument-mismatch ../configure --with-hdf5=`pwd`/../hdf5-1.14.4-3/include,`pwd`/../hdf5-1.14.4-3/lib --enable-pythonmodule --enable-json --prefix=`pwd`/myinstall
        make -j 8 install

    - name: Build Tests
      run: |
        export PATH="$PWD/hdf5-1.14.4-3/bin:$PATH"
        cd build/tests
        make -j 8 tests

    - name: Check Silo
      id: makecheck
      continue-on-error: true
      run: |
        export PATH="$PWD/hdf5-1.14.4-3/bin:$PATH"
        cd build
        make -j 8 check

    - name: Package artifact
      id: pack
      if: ${{ steps.makecheck.outcome == 'failure' }}
      run: |
        cd build/tests
        tar -cJf testsuite.dir.tar.xz testsuite.dir testsuite.log

    - name: Upload artifact
      if: ${{ steps.makecheck.outcome == 'failure' }}
      uses: actions/upload-artifact@v4
      with:
        name: testsuite.dir.tar.xz
        path: build/tests/testsuite.dir.tar.xz
        if-no-files-found: error
        retention-days: 14

    # Re-signal the failure so the job ends red.
    - name: Fail job if make check failed
      if: ${{ steps.makecheck.outcome == 'failure' }}
      run: exit 1
